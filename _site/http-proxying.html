<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      HTTP Proxying with Mitmproxy &middot; phackt.com:~#
    
  </title>

  
  <link rel="canonical" href="http://localhost:4000/http-proxying">
  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox" checked>

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Some infosec stuff.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about">About</a>
        
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="/archive/v1.1.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">phackt.com:~#</a>
            <small>Let's talk about sec, baby!</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">HTTP Proxying with Mitmproxy</h1>
  <span class="post-date">01 Oct 2016</span>
  <p>Bonjour à tous,</p>

<p>Pour faire suite à l’<a href="http://localhost:4000/mitm-phishing">article</a> que j’avais rédigé sur une attaque MITM redirigeant vers un site web spoofé, je me suis penché sur une autre méthode plus générique qui utilise l’outil <a href="https://mitmproxy.org/">mitmproxy</a>.</p>

<p>Toujours dans un contexte MITM, l’objectif est d’identifier les liens sécurisés et redirections (<strong>https</strong>), de les ‘stripper’ en <strong>http</strong>, dans le but de maintenir le type de connexion suivante:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>victime &lt;-- HTTP --&gt; mitmproxy &lt;-- HTTPS --&gt; website
</code></pre></div></div>
<!--more-->

<p>Le but est, qu’à partir d’une page non sécurisée d’un site, nous puissions continuer en proposant à notre victime une connexion en clair (http) pour analyser son trafic, mais que notre proxy rétablisse la connexion sécurisée avec le site concerné. Cette attaque ne pourra pas aboutir sur des sites implémentant le <a href="https://https.cio.gov/hsts/">HSTS</a> (sauf si l’utilisateur ne s’est jamais connecté au site et que le HSTS n’est pas préchargé).</p>

<p>Le stripping est effectué par le script <a href="https://github.com/phackt/mitm/blob/master/script/sslstrip.py">sslstrip.py</a>, qui permet également de supprimer d’autres headers de sécurité, notamment les fameux cookies <strong>secure</strong> que nous avons abordés dans un <a href="http://localhost:4000/xss-cors-csrf-partie-2-xss-cookies-session">article précédent</a>.</p>

<p>Vous trouverez le projet full et à jour (de nouvelles features apparaissent régulièrement) sur mon <a href="https://github.com/phackt/mitm">github</a>.</p>

<p>J’ai également créé un petit script python, <a href="https://github.com/phackt/mitm/blob/master/bin/chk_poison.py">chk_poison.py</a>, qui va vérifier que votre ARP poisoning est opérationnel dans les deux sens (Victime &lt;-&gt; Passerelle). N’oubliez pas que certaines protections filtrent les résolutions ARP non légitimes.</p>

<p>Vous pouvez tester mitmproxy sans attaque MITM, en l’utilisant en mode <a href="http://docs.mitmproxy.org/en/stable/modes.html">Regular</a>. La commande sera la suivante:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mitmproxy <span class="nt">--anticache</span> <span class="nt">--host</span> <span class="nt">--anticomp</span> <span class="nt">--noapp</span> <span class="nt">--script</span> ./sslstrip.py <span class="nt">--eventlog</span>
</code></pre></div></div>

<p>Il convient ensuite de configurer votre navigateur avec le proxy http <strong>127.0.0.1:8080</strong>. <strong>Ne mettez rien pour le proxy https</strong>, l’objectif ici n’est pas de générer à la volée de faux certificats et donc nous ne souhaitons pas capturer le trafic chiffré.</p>

<p>*UPDATES: mitm.sh permet également d’injecter un payload javascript (ex Beef) dans les pages de la victime et d’effectuer une attaque de social engineering par DNS spoofing.</p>

<p>Voir un exemple du projet et de l’attaque sur ce post: <a href="https://phackt.com/mitm-keep-plain-connection-example">https://phackt.com/mitm-non-hsts-example</a>*</p>

<p><strong>CONCLUSION:</strong></p>

<p><strong>Sur vos sites web, sécurisez toutes vos pages (domaines et sous domaines). Ne laissez aucune opportunité à un assaillant de manipuler le trafic.</strong></p>

<p><strong>N’hésitez pas à soumettre vos idées, à contribuer au github, et à partager.</strong></p>

<p>Je vous dis à très bientôt!</p>

</div>


<div class="related">
  <h2>Related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/git-secrets-exposed">
            What solutions to prevent git leaks ?
            <small>27 May 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/web-exposed-git-repositories">
            Gathering some information from web exposed git repositories
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/play-with-permissive-cors">
            Play with permissive CORS
            <small>24 Dec 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


      </div>
    </div>


    <!-- <label for="sidebar-checkbox" class="sidebar-toggle"></label> -->

    <script src='/public/js/script.js'></script>
 
  </body>
</html>
