<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      SLAE Assignment 5.3 - Msfvenom linux/x86/chmod shellcode Analysis &middot; Lanyon
    
  </title>

  
  <link rel="canonical" href="http://localhost:4000/certification/2017/04/26/slae-msf-chmod/">
  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox" checked>

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A reserved <a href="https://jekyllrb.com" target="_blank">Jekyll</a> theme that places the utmost gravity on content with a hidden drawer. Made by <a href="https://twitter.com/mdo" target="_blank">@mdo</a>.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about/">About</a>
        
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="/archive/v1.1.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Lanyon</a>
            <small>A Jekyll theme</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">SLAE Assignment 5.3 - Msfvenom linux/x86/chmod shellcode Analysis</h1>
  <span class="post-date">26 Apr 2017</span>
  <p><br />
Student <strong>SLAE - 891</strong><br />
Github: <a href="https://github.com/phackt/slae">https://github.com/phackt/slae</a><br />
<a href="http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></p>

<h2 id="assignment-53">Assignment 5.3:</h2>

<p><strong>Our Goal:</strong></p>
<blockquote>
  <p><em>Take up at least 3 linux/x86 shellcodes using Msfpayload (now Msfvenom)</em></p>
  <ul>
    <li><em>Use GDB/Ndisasm/Libemu to dissect the functionality of the shellcode</em></li>
    <li><em>Present your analysis</em></li>
  </ul>
</blockquote>

<p>Hello everybody,</p>

<p>Here we are for the last shellcode of the msfvenom serie. We will use this time the <strong>linux/x86/chmod</strong> shellcode and will analyse it thanks to GDB:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># msfvenom -p linux/x86/chmod --payload-options</span>
Options <span class="k">for </span>payload/linux/x86/chmod:


       Name: Linux Chmod
       Module: payload/linux/x86/chmod
       Platform: Linux
       Arch: x86
       Needs Admin: No
       Total size: 36
       Rank: Normal

Provided by:
    kris katterjohn &lt;katterjohn@gmail.com&gt;

Basic options:
Name  Current          Setting     Required  Description
<span class="nt">----</span>  <span class="nt">---------------</span>  <span class="nt">--------</span>    <span class="nt">-----------</span>
FILE  /etc/shadow      <span class="nb">yes         </span>Filename to <span class="nb">chmod
</span>MODE  0666             <span class="nb">yes         </span>File mode <span class="o">(</span>octal<span class="o">)</span>

Description:
  Runs <span class="nb">chmod </span>on specified file with specified mode
...
</code></pre></div></div>

<p>Let’s generate the ELF:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># msfvenom -p linux/x86/chmod FILE=/tmp/slae.txt -f elf -o chmod_slae</span>
No platform was selected, choosing Msf::Module::Platform::Linux from the payload
No Arch selected, selecting Arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 38 bytes
Final size of elf file: 122 bytes
Saved as: chmod_slae
<span class="c"># ls -l /tmp/slae.txt </span>
<span class="nt">-r--r--r--</span> 1 root root 0 avril 22 04:54 /tmp/slae.txt
<span class="c"># chmod +x ./chmod_slae &amp;&amp; ./chmod_slae</span>
<span class="c"># ls -l /tmp/slae.txt </span>
<span class="nt">-rw-rw-rw-</span> 1 root root 0 avril 22 04:54 /tmp/slae.txt
</code></pre></div></div>

<p>Perfect we see that our file <strong>/tmp/slae.txt</strong> has now the octal right <strong>666</strong> standing for <strong>rw-rw-rw-</strong>.  Let’s have a look in gdb:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># readelf -h ./chmod_slae
...
Adresse du point d'entrée:    0x8048054 
...
# gdb -q ./chmod_slae 
Reading symbols from ./chmod_slae...(no debugging symbols found)...done.
gdb-peda$ br *0x8048054
Breakpoint 1 at 0x8048054
gdb-peda$ run
gdb-peda$ disas $eip,+38
Dump of assembler code from 0x8048054 to 0x804807a:
=&gt; 0x08048054:	cdq    
   0x08048055:	push   0xf
   0x08048057:	pop    eax
   0x08048058:	push   edx
   0x08048059:	call   0x804806c
   0x0804805e:	das    
   0x0804805f:	je     0x80480ce
   0x08048061:	jo     0x8048092
   0x08048063:	jae    0x80480d1
   0x08048065:	popa   
   0x08048066:	gs cs je 0x80480e2
   0x0804806a:	je     0x804806c
   0x0804806c:	pop    ebx
   0x0804806d:	push   0x1b6
   0x08048072:	pop    ecx
   0x08048073:	int    0x80
   0x08048075:	push   0x1
   0x08048077:	pop    eax
   0x08048078:	int    0x80
End of assembler dump.
</code></pre></div></div>

<p>Let’s add some breakpoints on interesting opcodes:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>br <span class="k">*</span>0x0804806c
Breakpoint 2 at 0x804806c
gdb-peda<span class="nv">$ </span>br <span class="k">*</span>0x08048073
Breakpoint 3 at 0x8048073
gdb-peda<span class="nv">$ </span>br <span class="k">*</span>0x08048078
Breakpoint 4 at 0x8048078
gdb-peda<span class="nv">$ </span>c
Continuing.
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0xf 
EBX: 0x0 
ECX: 0x0 
EDX: 0x0 
ESI: 0x0 
EDI: 0x0 
EBP: 0x0 
ESP: 0xbffff2c8 <span class="nt">--</span><span class="o">&gt;</span> 0x804805e <span class="o">(</span><span class="s2">"/tmp/slae.txt"</span><span class="o">)</span>
EIP: 0x804806c <span class="nt">--</span><span class="o">&gt;</span> 0x1b6685b
EFLAGS: 0x202 <span class="o">(</span>carry parity adjust zero sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
   0x8048065:	popa   
   0x8048066:	gs cs je 0x80480e2
   0x804806a:	je     0x804806c
<span class="o">=&gt;</span> 0x804806c:	pop    ebx
   0x804806d:	push   0x1b6
   0x8048072:	pop    ecx
   0x8048073:	int    0x80
   0x8048075:	push   0x1
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xbffff2c8 <span class="nt">--</span><span class="o">&gt;</span> 0x804805e <span class="o">(</span><span class="s2">"/tmp/slae.txt"</span><span class="o">)</span>
0004| 0xbffff2cc <span class="nt">--</span><span class="o">&gt;</span> 0x0 
0008| 0xbffff2d0 <span class="nt">--</span><span class="o">&gt;</span> 0x1 
0012| 0xbffff2d4 <span class="nt">--</span><span class="o">&gt;</span> 0xbffff478 <span class="o">(</span><span class="s2">"/root/Documents/pentest/certs/slae/exam/assignment5.3/chmod_slae"</span><span class="o">)</span>
0016| 0xbffff2d8 <span class="nt">--</span><span class="o">&gt;</span> 0x0 
0020| 0xbffff2dc <span class="nt">--</span><span class="o">&gt;</span> 0xbffff4b9 <span class="o">(</span><span class="s2">"XDG_VTNR=2"</span><span class="o">)</span>
0024| 0xbffff2e0 <span class="nt">--</span><span class="o">&gt;</span> 0xbffff4c4 <span class="o">(</span><span class="s2">"XDG_SESSION_ID=2"</span><span class="o">)</span>
0028| 0xbffff2e4 <span class="nt">--</span><span class="o">&gt;</span> 0xbffff4d5 <span class="o">(</span><span class="s2">"SSH_AGENT_PID=1067"</span><span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
</code></pre></div></div>

<p>Notice that we are using <a href="https://github.com/longld/peda">gdb-peda</a>.  Thanks to the call technique the next instruction <code class="language-plaintext highlighter-rouge">pop ebx</code> will pop the address of the string <em>/tmp/slae</em> in the EBX register.</p>

<p>So we will have:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EAX: 0xf 
EBX: 0x804805e <span class="o">(</span>/tmp/slae.txt<span class="o">)</span> 
</code></pre></div></div>

<p>Finally if we stop at the address <strong>0x8048073</strong> just before our syscall:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EAX: 0xf 
EBX: 0x804805e <span class="o">(</span><span class="s2">"/tmp/slae.txt"</span><span class="o">)</span>
ECX: 0x1b6 
</code></pre></div></div>

<p>We will call <code class="language-plaintext highlighter-rouge">int chmod(const char *pathname, mode_t mode);</code>. The second argument <strong>0x1b6</strong> is <strong>666</strong> in octal:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># printf "%o\n" 0x1b6</span>
666
</code></pre></div></div>

<p>Let’s go to the following breakpoint:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EAX: 0x1 
EBX: 0x804805e <span class="o">(</span>/tmp/slae.txt<span class="o">)</span> 
</code></pre></div></div>

<p>We will call <code class="language-plaintext highlighter-rouge">void _exit(int status);</code>, the exit status is not important in a shellcode execution context, so we won’t add an opcode to set EBX.</p>

<p>Finally, our shellcode will change the permissions of our file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>n
<span class="o">[</span>Inferior 1 <span class="o">(</span>process 24785<span class="o">)</span> exited with code 0136]
Warning: not running or target is remote
</code></pre></div></div>

<p>So we just finished our msfvenom shellcodes serie. Soon we will deal with polymorphic shellcodes and crypters.<br />
Hope you enjoyed this post.</p>

<p><a href="https://twitter.com/phackt_ul">Phackt</a></p>

</div>


<div class="related">
  <h2>Related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/dev/2020/05/27/git-secrets-exposed/">
            What solutions to prevent git leaks ?
            <small>27 May 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/web/2018/08/05/web-exposed-git-repositories/">
            Gathering some information from web exposed git repositories
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/web/2017/12/24/play-with-permissive-cors/">
            Play with permissive CORS
            <small>24 Dec 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


      </div>
    </div>


    <!-- <label for="sidebar-checkbox" class="sidebar-toggle"></label> -->

    <script src='/public/js/script.js'></script>
 
  </body>
</html>
