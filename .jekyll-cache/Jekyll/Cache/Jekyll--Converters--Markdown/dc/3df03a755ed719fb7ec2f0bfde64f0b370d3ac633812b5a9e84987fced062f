I"œT<p>Hello folks,</p>

<p>Today i would like to share with you the first version of a script i wrote to help determining the version of a software.</p>

<p><strong>So what the hell am i talking about?</strong></p>

<p>Ok let me explain the context: You are looking at a website and trying to get the exact version of the underlying CMS, let say Drupal. We know that Drupal has suffered from the <a href="https://www.drupal.org/project/drupalgeddon">Drupalgeddon</a> for versions 7.X before 7.32. So you can have at look at some obvious files (CHANGELOG.txt), but what happens if the webmaster deleted these files? How to maximize the chance to find the right version or at least the smallest delta as possible ?
<!--more--></p>

<p>A tool was existing for that purpose, <a href="https://github.com/lokifer/BlindElephant">BlindElephant</a>, but it is not maintained anymore. So i chose to write my own script matching my needs (hand made with love). Of course donâ€™t hesitate to contact me and let me know if you took time to have BlindElephant in a working state with the CMS hashes databases up-to-date.</p>

<p>So now after your recon phase you have your target using Drupal CMS (it will work with any CMS files versioned on GIT). Here we will install a Drupal on our local machine.<br />
<a href="https://github.com/jekyc/wig">WebApp Information Gatherer</a> may helps your to identify it:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./wig.py http://localhost/drupal
...
Name           Versions          Type               
Drupal         7                 CMS   
...
</code></pre></div></div>

<p>Of course if you can hit some files leaking the CMS version, in this case everything is already folded:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl --silent http://localhost/drupal/CHANGELOG.txt | head -1
Drupal 7.29, 2014-07-16
</code></pre></div></div>

<p>You also can look for some obvious information in the response headers or for any meta information in the HTML page. But if the webmaster did its job, nothing will leak so how can we fingerprint our CMS?</p>

<p>What do you need:</p>
<ul>
  <li>access to versioned project</li>
  <li>find the most relevant (updated) files as input files (git log)</li>
  <li>download these files from your target</li>
  <li>hash all these input files and their GIT releases equivalent</li>
  <li>compare input files hashes with the releases ones</li>
</ul>

<p>Following all these steps will help to determine the most likely versions of the underlying CMS.</p>

<p>So first download the last version of <a href="https://raw.githubusercontent.com/phackt/pentest/master/fingerprint/web/versionchecker.sh">versionchecker.sh</a>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> wget https://raw.githubusercontent.com/phackt/pentest/master/fingerprint/web/versionchecker.sh
<span class="nb">chmod</span> +x versionchecker.sh
</code></pre></div></div>

<p>Then clone the <a href="https://github.com/drupal/drupal">Drupal repo</a>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/drupal/drupal.git
<span class="nb">cd </span>drupal/
</code></pre></div></div>

<p>Now we will look for our relevant input files:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git log <span class="nt">--all</span> <span class="nt">--pretty</span><span class="o">=</span>format: <span class="nt">--name-only</span> | egrep <span class="nt">-v</span> <span class="s2">"^core/"</span> | egrep <span class="nt">-i</span> <span class="s2">"(.js</span><span class="nv">$|</span><span class="s2">.html</span><span class="nv">$|</span><span class="s2">.css</span><span class="nv">$)</span><span class="s2">"</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-rg</span> | <span class="nb">head</span> <span class="nt">-30</span> | <span class="nb">tee</span> /tmp/relevant_files.txt
warning: inexact rename detection was skipped due to too many files.
warning: you may want to <span class="nb">set </span>your diff.renameLimit variable to at least 4708 and retry the command.
    170 misc/drupal.css
    106 themes/seven/style.css
    106 themes/garland/style.css
    102 misc/drupal.js
     85 modules/system/system.css
     78 modules/overlay/overlay-parent.js
     72 themes/bartik/css/style.css
     67 misc/tabledrag.js
     57 misc/autocomplete.js
     55 themes/xtemplate/xtemplate.css
     55 modules/system/system.js
     52 misc/ajax.js
     42 misc/collapse.js
     41 misc/textarea.js
     41 misc/tableheader.js
     37 themes/pushbutton/style.css
     35 themes/bluemarine/style.css
     35 modules/user/user.js
     35 misc/progress.js
     33 modules/user/user.css
     32 modules/toolbar/toolbar.css
     30 misc/tableselect.js
     29 modules/system/admin.css
     28 themes/garland/style-rtl.css
     28 misc/jquery.js
     26 modules/color/color.js
     26 modules/block/block.js
     25 misc/teaser.js
     24 themes/bartik/css/style-rtl.css
     24 modules/node/node.css
     23 themes/chameleon/common.css
     23 modules/toolbar/toolbar.js
     23 modules/system/system-rtl.css
     22 modules/dashboard/dashboard.css
     22 misc/ahah.js
     21 themes/garland/fix-ie.css
     20 themes/xtemplate/pushbutton/xtemplate.css
     20 modules/overlay/overlay-parent.css
     20 modules/openid/openid.js
     20 modules/book/book.css
</code></pre></div></div>

<p>We are looking for the most commited static files (.js, .html, .css), not beginning by <em>core/</em> (Drupal 8 hierarchy, we are looking for a Drupal 7 version here) and saving the results in <em>/tmp/relevant_files.txt</em>.</p>

<p>Letâ€™s download these files from our target in order to be processed by the <strong>versionchecker.sh</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> ../input <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ../input
<span class="k">for </span>file <span class="k">in</span> <span class="si">$(</span><span class="nb">cat</span> /tmp/relevant_files.txt | <span class="nb">sed</span> <span class="nt">-r</span> <span class="s1">'s/^ +//g'</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="s1">' '</span> <span class="nt">-f2</span><span class="si">)</span><span class="p">;</span><span class="k">do </span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="si">$(</span><span class="nb">dirname</span> <span class="nv">$file</span><span class="si">)</span> 2&gt;/dev/null<span class="p">;</span>wget <span class="nt">-O</span> <span class="nv">$file</span> <span class="s2">"http://localhost/drupal/</span><span class="nv">$file</span><span class="s2">"</span><span class="p">;</span><span class="k">done</span>
</code></pre></div></div>

<p>In the input directory we need to keep the hierarchy of relevant files in order to find them in the GIT repo. Some files may not be found for the target release. As an option, you can pass a pattern to grep the tags you want after the script has executed the <code class="language-plaintext highlighter-rouge">git tag</code> command (to find all the releases).</p>

<p>Letâ€™s run our <strong>versionchecker.sh</strong> (currently only working for git versioning system):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> .. <span class="o">&amp;&amp;</span> ./versionchecker.sh <span class="nt">-s</span> ./input/ <span class="nt">-g</span> ./drupal/ <span class="nt">-p</span> <span class="s2">"^[78]</span><span class="se">\.</span><span class="s2">[0-9.]+$"</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Input files directory: /tmp/input
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning empty files and directory <span class="k">in</span> /tmp/input - Done
<span class="o">[</span><span class="k">*</span><span class="o">]</span> GIT repository: /root/Documents/repo/drupal
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Grep pattern: ^7<span class="se">\.</span><span class="o">[</span>0-9]+<span class="err">$</span>
        ___           ___           ___           ___                       ___           ___       
       /<span class="se">\_</span>_<span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>         ___        /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\_</span>_<span class="se">\ </span>     
      /:/  /        /::<span class="se">\ </span> <span class="se">\ </span>      /::<span class="se">\ </span> <span class="se">\ </span>      /::<span class="se">\ </span> <span class="se">\ </span>       /<span class="se">\ </span> <span class="se">\ </span>     /::<span class="se">\ </span> <span class="se">\ </span>      /::|  |     
     /:/  /        /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/<span class="se">\ \ </span> <span class="se">\ </span>      <span class="se">\:\ </span> <span class="se">\ </span>   /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:|:|  |     
    /:/__/  ___   /::<span class="se">\~\:\ </span> <span class="se">\ </span>  /::<span class="se">\~\:\ </span> <span class="se">\ </span>  _<span class="se">\:\~\ \ </span> <span class="se">\ </span>     /::<span class="se">\_</span>_<span class="se">\ </span> /:/  <span class="se">\:\ </span> <span class="se">\ </span>  /:/|:|  |__   
    |:|  | /<span class="se">\_</span>_<span class="se">\ </span>/:/<span class="se">\:\ \:\_</span>_<span class="se">\ </span>/:/<span class="se">\:\ \:\_</span>_<span class="se">\ </span>/<span class="se">\ \:\ \ \_</span>_<span class="se">\ </span> __/:/<span class="se">\/</span>__/ /:/__/ <span class="se">\:\_</span>_<span class="se">\ </span>/:/ |:| /<span class="se">\_</span>_<span class="se">\ </span> 
    |:|  |/:/  / <span class="se">\:\~\:\ \/</span>__/ <span class="se">\/</span>_|::<span class="se">\/</span>:/  / <span class="se">\:\ \:\ \/</span>__/ /<span class="se">\/</span>:/  /    <span class="se">\:\ </span> <span class="se">\ </span>/:/  / <span class="se">\/</span>__|:|/:/  /  
    |:|__/:/  /   <span class="se">\:\ \:\_</span>_<span class="se">\ </span>     |:|::/  /   <span class="se">\:\ \:\_</span>_<span class="se">\ </span>  <span class="se">\:</span>:/__/      <span class="se">\:\ </span> /:/  /      |:/:/  /   
     <span class="se">\:</span>:::/__/     <span class="se">\:\ \/</span>__/      |:|<span class="se">\/</span>__/     <span class="se">\:\/</span>:/  /    <span class="se">\:\_</span>_<span class="se">\ </span>      <span class="se">\:\/</span>:/  /       |::/  /    
      ~~~~          <span class="se">\:\_</span>_<span class="se">\ </span>       |:|  |        <span class="se">\:</span>:/  /      <span class="se">\/</span>__/        <span class="se">\:</span>:/  /        /:/  /     
                     <span class="se">\/</span>__/         <span class="se">\|</span>__|         <span class="se">\/</span>__/                     <span class="se">\/</span>__/         <span class="se">\/</span>__/      
        ___           ___           ___           ___           ___           ___           ___     
       /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\_</span>_<span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\_</span>_<span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>        /<span class="se">\ </span> <span class="se">\ </span>   
      /::<span class="se">\ </span> <span class="se">\ </span>      /:/  /        /::<span class="se">\ </span> <span class="se">\ </span>      /::<span class="se">\ </span> <span class="se">\ </span>      /:/  /        /::<span class="se">\ </span> <span class="se">\ </span>      /::<span class="se">\ </span> <span class="se">\ </span>  
     /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/__/        /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/__/        /:/<span class="se">\:\ </span> <span class="se">\ </span>    /:/<span class="se">\:\ </span> <span class="se">\ </span> 
    /:/  <span class="se">\:\ </span> <span class="se">\ </span>  /::<span class="se">\ </span> <span class="se">\ </span>___   /::<span class="se">\~\:\ </span> <span class="se">\ </span>  /:/  <span class="se">\:\ </span> <span class="se">\ </span>  /::<span class="se">\_</span>_<span class="se">\_</span>___   /::<span class="se">\~\:\ </span> <span class="se">\ </span>  /::<span class="se">\~\:\ </span> <span class="se">\ </span>
   /:/__/ <span class="se">\:\_</span>_<span class="se">\ </span>/:/<span class="se">\:\ </span> /<span class="se">\_</span>_<span class="se">\ </span>/:/<span class="se">\:\ \:\_</span>_<span class="se">\ </span>/:/__/ <span class="se">\:\_</span>_<span class="se">\ </span>/:/<span class="se">\:</span>::::<span class="se">\_</span>_<span class="se">\ </span>/:/<span class="se">\:\ \:\_</span>_<span class="se">\ </span>/:/<span class="se">\:\ \:\_</span>_<span class="se">\</span>
   <span class="se">\:\ </span> <span class="se">\ </span> <span class="se">\/</span>__/ <span class="se">\/</span>__<span class="se">\:\/</span>:/  / <span class="se">\:\~\:\ \/</span>__/ <span class="se">\:\ </span> <span class="se">\ </span> <span class="se">\/</span>__/ <span class="se">\/</span>_|:|~~|~    <span class="se">\:\~\:\ \/</span>__/ <span class="se">\/</span>_|::<span class="se">\/</span>:/  /
    <span class="se">\:\ </span> <span class="se">\ </span>           <span class="se">\:</span>:/  /   <span class="se">\:\ \:\_</span>_<span class="se">\ </span>   <span class="se">\:\ </span> <span class="se">\ </span>         |:|  |      <span class="se">\:\ \:\_</span>_<span class="se">\ </span>     |:|::/  / 
     <span class="se">\:\ </span> <span class="se">\ </span>          /:/  /     <span class="se">\:\ \/</span>__/     <span class="se">\:\ </span> <span class="se">\ </span>        |:|  |       <span class="se">\:\ \/</span>__/      |:|<span class="se">\/</span>__/  
      <span class="se">\:\_</span>_<span class="se">\ </span>        /:/  /       <span class="se">\:\_</span>_<span class="se">\ </span>       <span class="se">\:\_</span>_<span class="se">\ </span>       |:|  |        <span class="se">\:\_</span>_<span class="se">\ </span>       |:|  |    
       <span class="se">\/</span>__/         <span class="se">\/</span>__/         <span class="se">\/</span>__/         <span class="se">\/</span>__/         <span class="se">\|</span>__|         <span class="se">\/</span>__/         <span class="se">\|</span>__|    


<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hint: <span class="k">for </span>choosing relevant files to compare from a GIT repository:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> git log <span class="nt">--all</span> <span class="nt">--pretty</span><span class="o">=</span>format: <span class="nt">--name-only</span> | egrep <span class="nt">-i</span> <span class="s2">"(.js</span><span class="nv">$|</span><span class="s2">.html</span><span class="nv">$|</span><span class="s2">.css</span><span class="nv">$)</span><span class="s2">"</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-rg</span> | <span class="nb">head</span> <span class="nt">-20</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> /tmp/work/hashes.txt found. Are you sure you want to overwrite and compute hashes <span class="o">[</span>Y/n]: 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">-----------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Looking <span class="k">for </span>tag: 7.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">-----------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Looking <span class="k">for </span>tag: 7.1
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">-----------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Looking <span class="k">for </span>tag: 7.2
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">-----------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Looking <span class="k">for </span>tag: 7.3
...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">-----------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Checking filename /tmp/input/modules/color/color.js: abce1b13050367ea1c8806888c29b383
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">-----------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Checking filename /tmp/input/modules/user/user.css: 1162bec186856e63a6ca207b04282816
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">-----------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Checking filename /tmp/input/modules/user/user.js: 0409afa4203df9e19e5754663bf27ba8
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">-----------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Checking filename /tmp/input/modules/overlay/overlay-parent.js: 9e7f29219143a79e528a59f1e5e2ab6e
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Thanks to strong and costly mathematical and statistical calculation:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> min version: 7.29
<span class="o">[</span><span class="k">*</span><span class="o">]</span> max version: 7.32
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Number of input files: 23
<span class="o">[</span><span class="k">*</span><span class="o">]</span> All input files have been found <span class="k">in </span>the following versions: 
7.32
7.31
7.30
7.29
</code></pre></div></div>

<p>The script is computing hashes for every input files found and for every git tags. If one input file is not found, the script will fail because we can not precisely determine a version that matches all input files.</p>

<p>In our example, we finally have 23 input files from 30 relevant files (some have not been found on our target). The final comparison between the input files hashes and the git tags hashes shows that the whole 23 input hashes match the versions 7.32, 7.31, 7.30, <strong>7.29</strong>.</p>

<p>So we found the real version in our script suggestions (7.29).<br />
You also can try with some others CMS like Wordpress. Here is what we got for example with a <strong>Wordpress 4.6</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./versionchecker.sh <span class="nt">-s</span> ./input/ <span class="nt">-g</span> ~/Documents/repo/WordPress/ <span class="nt">-p</span> <span class="s2">"^4(</span><span class="se">\.</span><span class="s2">[0-9])+$"</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Input files directory: /tmp/input
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning empty files and directory <span class="k">in</span> /tmp/input - Done
<span class="o">[</span><span class="k">*</span><span class="o">]</span> GIT repository: /root/Documents/repo/WordPress
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Grep pattern: ^4<span class="o">(</span><span class="se">\.</span><span class="o">[</span>0-9]<span class="o">)</span>+<span class="err">$</span>
...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> min version: 4.6
<span class="o">[</span><span class="k">*</span><span class="o">]</span> max version: 4.6
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Number of input files: 24
<span class="o">[</span><span class="k">*</span><span class="o">]</span> All input files have been found <span class="k">in </span>the following versions: 
4.6
</code></pre></div></div>

<p>For wordpress we have only one possible version matching all the input files we provided thanks to the same procedure as seen for the Drupal CMS. We clearly know right now which version the CMS is running, <strong>4.6</strong>.</p>

<p>Hope it may helps you, give you some ideas, make you think about how to reduce your fingerprinting entropy.</p>

<p>Cheers,<br />
Phackt.</p>
:ET